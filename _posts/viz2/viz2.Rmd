---
title: "Visualization #2"
description: |
  Comparing self-regulation scores by race
author:
  - name: Joanna Wright
    url: https://github.com/jhwrigh23
date: 03-09-2020
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r libraries, echo=TRUE}
library(tidyverse)
library(rio)
library(here)
library(janitor)
library(gt)
library(ggrepel)
```


```{r loading-the-data}

d <- import(here("data", "ka_2018-19_lookback_report.xlsx")) %>%
  clean_names()

```

```{r cleaning-the-data, results='hide'}

d_tidy <- d %>%
  rename(county = oregon_kindergarten_assessment,
         district_id = x2,
         district = x3,
         inst_id = x4,
         inst_name = x5,
         inst_type = x6,
         stu_grp_type = x7,
         stu_grp = x8,
         avg_self_reg = x9) %>%
  select(c(1:9))

d_tidy <- d_tidy %>%
  filter(avg_self_reg != "*")

d_tidy = d_tidy[-1,]

str(d_tidy)
d_tidy$avg_self_reg = as.numeric(d_tidy$avg_self_reg)

```

```{r }

d2 <- d_tidy %>%
  filter(stu_grp == "Asian" |
           stu_grp == "White" |
           stu_grp == "Multi-Racial" |
           stu_grp == "Native Hawaiian/Pacific Islander" |
           stu_grp == "Hispanic/Latino" |
           stu_grp == "Black/African American" |
           stu_grp == "American Indian/Alaska Native")

```

The purpose of Plot 2 is to explore variation in self-regulation scores by race in Oregon. 

First, just to get an overall sense of the data, I plotted average scores by race. 

```{r viz2-vers1}

d2 %>%
  group_by(stu_grp) %>%
  summarise(avg_self_reg_race = mean(avg_self_reg)) %>%
  ggplot(aes(fct_reorder(stu_grp, avg_self_reg_race), avg_self_reg_race)) +
  geom_point() +
  coord_flip() + 
  labs(title = "Average self-regulation by race",
       x = NULL,
       y = "Self-regulation score")

```

To explore the data further, I  plotted distributions in a couple of difference ways.  

```{r viz2-vers2-3-4}

d2 %>%
ggplot(aes(avg_self_reg, fct_reorder(stu_grp, avg_self_reg))) +
  ggridges::geom_density_ridges(color = "white", 
                                fill = "cornflowerblue", 
                                alpha = 0.8) + 
  theme_minimal(base_size = 10) + 
  scale_x_continuous("Self Regulation Scores") +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_line(color = "gray80")) +
  labs(title = "Self-Regulation Scores by Race",
       x = NULL,
       y = NULL)

d2 %>%
  ggplot(aes(avg_self_reg, fct_reorder(stu_grp, avg_self_reg))) +
  geom_violin(fill = "cornflowerblue")

d2 %>%
  ggplot(aes(avg_self_reg, fct_reorder(stu_grp, avg_self_reg), fill = stu_grp)) +
  geom_violin() +
  labs(title = "Distribution of self-regulation scores by race",
       x = "Score (1-5 scale)",
       y = NULL) +
  theme_minimal() + 
  scale_color_brewer(palette = "Accent") +
  theme(plot.title = element_text(hjust = 1)) +
  theme(legend.position = "none") 

```

```{r, fig.width=13, fig.height=4}

d2 %>%
  ggplot(aes(avg_self_reg)) +
  geom_density(aes(fill = stu_grp, bw = .5),
               show.legend = FALSE) +
  facet_wrap(~stu_grp, nrow = 1) + 
  theme_minimal() + 
  scale_color_brewer()

```

I refined what I thought was the most effective distribution plot further by changing the y-axis to proportion, making y-axis labels percentages, and making the plot larger:  

```{r, vs2, layout = "l-page", fig.width=13, fig.height=4}

d2 %>%
  ggplot(aes(avg_self_reg)) +
  geom_density(aes(y = ..scaled..,
                   fill = stu_grp, 
                   bw = .5),
                  show.legend = FALSE) +
  facet_wrap(~stu_grp, nrow = 1) + 
  theme_minimal() + 
  scale_color_brewer() +
  labs(title = "Distributions of Self-Regulation Scores by Race in Oregon",
       subtitle = "Averages from 2018-2019 school year",
       x = "Self-Regulation Score (on a 1-5 scale)",
       y = NULL) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14)) +
  scale_y_continuous(name = "Percentage", labels=scales::percent)

```

This gives us an overall sense of distribution of scores by race. However, to put these numbers in context, it is important to know that some student groups are represented much more strongly than others. A quick plot of totals by student race can tell us this:  

```{r results='hide'}

 d2 %>%
  group_by(stu_grp) %>%
  count()

counts <- d2 %>%
  group_by(stu_grp) %>%
  count() %>%
  rename(Race = stu_grp,
         Total = n)
             
```


```{r}
reactable::reactable(counts)
```

Given that White and Hispanic/Latino students make up a large proportion of the student population in this sample, I decided to look at difference in self-regulation scores between these groups. Like the other visualizations, I wanted to look at these differences across counties to see if there are particular counties for whom one group of students is scoring much higher or lower than the other.

First, I calculated the difference by subtracting the average Hispanic/Latino scores from the average White scores for each county and made an initial plot of the results:

```{r viz2}

d2 %>%
  filter(stu_grp == "White" |
           stu_grp == "Hispanic/Latino") %>%
  group_by(stu_grp, county) %>%
  summarise(avg_self_reg_race = mean(avg_self_reg)) %>%
  pivot_wider(
    names_from = stu_grp,
    values_from = avg_self_reg_race
  ) %>%
  mutate(white_hisp_diff = c(White - `Hispanic/Latino`)) %>%
  ggplot(aes(county, white_hisp_diff)) +
  geom_point() +
  coord_flip()

```

Of course, the first step for refining this is the reorder so that it's easier to see which counties show the greatest discrepancy. I used `fct_reorder` and then added `gghighlight` conditions to emphasize counties in which the difference between the two groups was greater than .25. 


```{r viz2-vers6}

d2 %>%
  filter(stu_grp == "White" |
           stu_grp == "Hispanic/Latino") %>%
  group_by(stu_grp, county) %>%
  summarise(avg_self_reg_race = mean(avg_self_reg)) %>%
  pivot_wider(
    names_from = stu_grp,
    values_from = avg_self_reg_race
  ) %>%
  mutate(white_hisp_diff = c(White - `Hispanic/Latino`)) %>%
  filter(white_hisp_diff != "NA") %>%
  ggplot(aes(fct_reorder(county, white_hisp_diff), white_hisp_diff)) +
  geom_point(col = "darkred") +
  coord_flip() + 
  gghighlight::gghighlight(white_hisp_diff < -.25 |
                             white_hisp_diff > .25,
                           unhighlighted_colour = alpha("steelblue", 0.4)) + 
  geom_point(col = "darkred", size = 2.5) + 
  labs(title = "Differences Self-Regulation Scores by Race in Oregon",
       subtitle = "Disparities in scores between White and Hispanic/Latino students",
       x = NULL,
       y = "Difference in scores")
  
```

But this doesn't tell us which counties show White students scoring higher than Hispanic/Latino, and which show the opposite trend. I thought maybe a legend could help with this. 

```{r viz2-vers7}

d2 %>%
  filter(stu_grp == "White" |
           stu_grp == "Hispanic/Latino") %>%
  group_by(stu_grp, county) %>%
  summarise(avg_self_reg_race = mean(avg_self_reg)) %>%
  pivot_wider(
    names_from = stu_grp,
    values_from = avg_self_reg_race
  ) %>%
  mutate(white_hisp_diff = c(White - `Hispanic/Latino`)) %>%
  filter(white_hisp_diff != "NA") %>%
  ggplot(aes(fct_reorder(county, white_hisp_diff), white_hisp_diff, 
         fill = white_hisp_diff > 0)) +
  geom_bar(stat = 'identity') +
  coord_flip() + 
  labs(title = "Differences Self-Regulation Scores by Race in Oregon",
       subtitle = "Disparities in scores between White and Hispanic/Latino students",
       x = NULL,
       y = "Difference in scores")

```

It's still hard to tell what the legend means, so I tried this another way: 

```{r viz2-vers8}

d2 %>%
  filter(stu_grp == "White" |
           stu_grp == "Hispanic/Latino") %>%
  group_by(stu_grp, county) %>%
  summarise(avg_self_reg_race = mean(avg_self_reg)) %>%
  pivot_wider(
    names_from = stu_grp,
    values_from = avg_self_reg_race
  ) %>%
  mutate(white_hisp_diff = c(White - `Hispanic/Latino`)) %>%
  filter(white_hisp_diff != "NA") %>%
  ggplot(aes(fct_reorder(county, white_hisp_diff), white_hisp_diff, 
         fill = white_hisp_diff > 0)) +
  geom_bar(stat = 'identity') +
  scale_fill_viridis_d(name = "Average White student scores higher than Hispanic/Latino") +
  coord_flip() + 
  labs(title = "Differences Self-Regulation Scores by Race in Oregon",
       subtitle = "Disparities in scores between White and Hispanic/Latino students",
       x = NULL,
       y = "Difference in scores") +
  theme_dark() + 
  theme(legend.position = "bottom")

```


```{r, preview=TRUE}

d2 %>%
  filter(stu_grp == "White" |
           stu_grp == "Hispanic/Latino") %>%
  group_by(stu_grp, county) %>%
  summarise(avg_self_reg_race = mean(avg_self_reg)) %>%
  pivot_wider(
    names_from = stu_grp,
    values_from = avg_self_reg_race
  ) %>%
  mutate(white_hisp_diff = c(White - `Hispanic/Latino`)) %>%
  filter(white_hisp_diff != "NA") %>%
  ggplot(aes(fct_reorder(county, white_hisp_diff), white_hisp_diff, 
         fill = white_hisp_diff > 0)) +
  geom_bar(stat = 'identity') +
  scale_fill_viridis_d(name = "Average White student scores higher than Hispanic/Latino") +
  coord_flip() + 
  labs(title = "Differences Self-Regulation Scores by Race in Oregon",
       subtitle = "Disparities in scores between White and Hispanic/Latino students",
       x = NULL,
       y = "Difference in scores") +
  theme_dark() + 
  theme(legend.position = "bottom")

```

This is getting pretty close! But I'm still stuck with a legend that is a pretty high cognitive load for the viewer. Then I thought that labels would be more effective.  

```{r}

d2 %>%
  filter(stu_grp == "White" |
           stu_grp == "Hispanic/Latino") %>%
  group_by(stu_grp, county) %>%
  summarise(avg_self_reg_race = mean(avg_self_reg)) %>%
  pivot_wider(
    names_from = stu_grp,
    values_from = avg_self_reg_race
  ) %>%
  mutate(white_hisp_diff = c(White - `Hispanic/Latino`)) %>%
  filter(white_hisp_diff != "NA") %>%
  ggplot(aes(fct_reorder(county, white_hisp_diff), white_hisp_diff, 
         fill = white_hisp_diff > 0)) +
  geom_bar(stat = 'identity') +
  scale_fill_brewer(name = "Average White student scores higher than Hispanic/Latino", 
                    palette = "Set2") +
  coord_flip() + 
  labs(title = "Differences Self-Regulation Scores by Race in Oregon",
       subtitle = "Disparities in scores between White and Hispanic/Latino students",
       x = NULL,
       y = "Difference in scores") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "bottom")

```



